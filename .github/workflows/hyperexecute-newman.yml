name: Inwarranty Flow - Newman API Tests on HyperExecute

on:
  push:
    branches: 
      - main
      - develop
      - staging
  pull_request:
    branches: 
      - main
  workflow_dispatch:  # Allows manual trigger from GitHub UI
  schedule:
    - cron: '0 10 * * 1-5'  # Run at 10 AM UTC, Monday to Friday

jobs:
  newman-hyperexecute-tests:
    runs-on: ubuntu-latest
    name: Run Inwarranty Flow Tests
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Verify Project Files
        run: |
          echo "Checking for required files..."
          if [ ! -f "collections/Inwarranty-flow Collection.postman_collection.json" ]; then
            echo "‚ùå Collection file not found!"
            exit 1
          fi
          if [ ! -f "environments/QA.postman_environment.json" ]; then
            echo "‚ùå Environment file not found!"
            exit 1
          fi
          if [ ! -f "data/testData.csv" ]; then
            echo "‚ùå Test data CSV file not found!"
            exit 1
          fi
          if [ ! -f ".hyperexecute.yaml" ]; then
            echo "‚ùå HyperExecute config not found!"
            exit 1
          fi
          echo "‚úÖ All required files are present"
      
      - name: Install Newman Dependencies
        run: |
          npm install
          echo "‚úÖ Newman and dependencies installed"
      
      - name: Create Reports Directory
        run: mkdir -p reports
      
      - name: Download HyperExecute CLI
        run: |
          echo "Downloading HyperExecute CLI..."
          wget https://downloads.lambdatest.com/hyperexecute/linux/hyperexecute
          chmod +x hyperexecute
          ./hyperexecute --version
          echo "‚úÖ HyperExecute CLI downloaded successfully"
      
      - name: Display HyperExecute Configuration
        run: |
          echo "üìã HyperExecute Configuration:"
          cat .hyperexecute.yaml
      
      - name: Execute Newman Tests on HyperExecute
        id: hyperexecute_run
        env:
          LT_USERNAME: ${{ secrets.LT_USERNAME }}
          LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}
        run: |
          echo "üöÄ Starting test execution on HyperExecute..."
          ./hyperexecute \
            --user "$LT_USERNAME" \
            --key "$LT_ACCESS_KEY" \
            --config .hyperexecute.yaml \
            --verbose \
            --download-artifacts \
            --force-clean-artifacts
        continue-on-error: true
      
      - name: List Generated Reports
        if: always()
        run: |
          echo "üìä Generated Reports:"
          ls -lah reports/ || echo "No reports directory found"
          find . -name "*.html" -o -name "*.json" | grep -i report || echo "No report files found"
      
      - name: Upload Newman HTML Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: newman-html-reports-${{ github.run_number }}
          path: |
            reports/*.html
            reports/*.json
          retention-days: 30
      
      - name: Upload HyperExecute Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: hyperexecute-artifacts-${{ github.run_number }}
          path: |
            .hyperexecute/
            artifacts/
          retention-days: 15
      
      - name: Generate Test Summary
        if: always()
        run: |
          echo "## üß™ Inwarranty Flow Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | QA |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Report Links" >> $GITHUB_STEP_SUMMARY
          echo "- Check the **Artifacts** section above to download HTML reports" >> $GITHUB_STEP_SUMMARY
          echo "- View detailed execution logs in [LambdaTest HyperExecute Dashboard](https://hyperexecute.lambdatest.com/)" >> $GITHUB_STEP_SUMMARY
      
      - name: Check Test Results
        if: steps.hyperexecute_run.outcome == 'failure'
        run: |
          echo "‚ùå Tests failed! Check the reports for details."
          exit 1
      
      - name: Success Message
        if: steps.hyperexecute_run.outcome == 'success'
        run: |
          echo "‚úÖ All tests passed successfully!"
