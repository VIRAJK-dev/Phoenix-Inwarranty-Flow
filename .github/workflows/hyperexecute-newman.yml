name: Inwarranty Flow - Newman API Tests on HyperExecute

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  newman-hyperexecute-tests:
    runs-on: ubuntu-latest
    name: Run Inwarranty Flow Tests
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Remove cache option to avoid lock file error
      
      - name: List Repository Files
        run: |
          echo "Files in repository root:"
          ls -la
          echo ""
          echo "Checking for required files:"
          test -f ".hyperexecute.yaml" && echo "✅ .hyperexecute.yaml found" || echo "❌ .hyperexecute.yaml NOT found"
          test -f "package.json" && echo "✅ package.json found" || echo "❌ package.json NOT found"
      
      - name: Verify Project Structure
        run: |
          echo "Checking for collection file:"
          test -f "Inwarranty-flow Collection.postman_collection.json" && echo "✅ Collection found" || echo "❌ Collection NOT found"
          echo "Checking for environment file:"
          test -f "QA.postman_environment.json" && echo "✅ Environment found" || echo "❌ Environment NOT found"
          echo "Checking for test data:"
          test -f "testData.csv" && echo "✅ Test data found" || echo "❌ Test data NOT found"
      
      - name: Install Newman Dependencies
        run: |
          npm install newman newman-reporter-htmlextra
          echo "✅ Newman and dependencies installed"
      
      - name: Create Reports Directory
        run: mkdir -p reports
      
      - name: Download HyperExecute CLI
        run: |
          echo "Downloading HyperExecute CLI..."
          wget https://downloads.lambdatest.com/hyperexecute/linux/hyperexecute
          chmod +x hyperexecute
          ./hyperexecute --version
      
      - name: Display HyperExecute Config
        run: |
          echo "HyperExecute Configuration:"
          cat .hyperexecute.yaml
      
      - name: Execute Newman Tests on HyperExecute
        env:
          LT_USERNAME: ${{ secrets.LT_USERNAME }}
          LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}
        run: |
          ./hyperexecute \
            --user "$LT_USERNAME" \
            --key "$LT_ACCESS_KEY" \
            --config .hyperexecute.yaml \
            --verbose
        continue-on-error: true
      
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports-${{ github.run_number }}
          path: reports/
          if-no-files-found: warn
      
      - name: Upload HyperExecute Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hyperexecute-artifacts-${{ github.run_number }}
          path: |
            .hyperexecute/
            artifacts/
          if-no-files-found: ignore
